"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const debug_1 = require("debug");
const serialize_1 = require("./serialize");
const types_1 = require("./types");
const debugLog = debug_1.default("unmock:fetch-mitm");
const isCreateResponse = (cb) => cb.length === 1;
exports.buildFetch = (cb) => function fetch(url, init) {
    const req = serialize_1.default(url, init);
    debugLog(`Serialized request: ${JSON.stringify(req)}, init: ${init}`);
    return new Promise((resolve, reject) => {
        const sendResponse = (res) => {
            const responseInit = { status: res.statusCode };
            resolve(new types_1.Response(res.body, responseInit));
        };
        const emitError = (e) => reject(e);
        setTimeout(() => {
            if (isCreateResponse(cb)) {
                try {
                    const res = cb(req);
                    sendResponse(res);
                }
                catch (err) {
                    reject(err);
                }
            }
            else {
                cb(req, sendResponse, emitError);
            }
        }, 0);
    });
};
exports.default = exports.buildFetch;
//# sourceMappingURL=fetch.js.map